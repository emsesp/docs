Some entities mapped in MQTT are generated by EMS-ESP and not read from the EMS bus.

`heating_active` and `tapwater_active` are calculated from the burner and valve/pump settings. These are used by both the Shower Timer and Energy Measurement features.

## Shower Timer

Measures the time hot water is running with burner on. This works only for dhw flow systems; in buffered dhw systems the time is always the charge time of the buffer.
As an additional feature, there is the Shower Alert, which alerts and triggers a burst of cold water after a configured time. The 'coldshot' is managed by the entity `boiler/tapactivated`, and uses a custom function that sets the boiler into its 'testmode', enables tapwater flow but disables the burner.

## Force Heating Off

Some users control the boiler without a thermostat and want to switch the boiler off when a desired temperature is reached. Sending `boiler/selflowtemp 0` to the boiler has to be repeated every minute otherwise the boiler will fall back to the selected temperature on the panel.

The function `boiler/forceheatingoff` repeats this command every minute, so the heating remains off. In the EMS-ESP settings it is possible to set the power on value of `forceheatingoff`.

## Energy Measurement

For gas and oil burners, Bosch does not measure the energy consumption. EMS-ESP calculates the consumption of each boiler message by burner modulation and nominal boiler power. Some gas boilers have the nominal power stored, some do not.
Also the stored power is not always correct, a boiler of same type could be equipped with different burners or have its burners adjusted by air/nozzle size.
In these cases, the nominal power `boiler/nonpower` can be changed and stored in EMS-ESP. Check the setting before using the energy values.

## Remote Thermostats

Modern thermostats can use the outdoor temperature to calculate the appropriate boiler flow temperature. A single thermostat placed inside the boiler can do this for different heating circuits, however it is slow and inaccurate. If a room thermostat measures that the actual temperature is much lower it should raise the flowtemp to a much higher value until the correct temperature is reached. This is called "outdoorcontrolled" with "room influence" and typically requires a physical remote thermostat present in the room. EMS-ESP can simulate such a remote thermostat. This is done by setting the Master thermostat's Control Device (`thermostat/hc<x>/control`) and sending the temperature and optionally humidity via `thermostat/hcx/remotetemp` and `thermostat/hcx/remotehum`. This will then send the values on to the master thermostat.

For a master thermostat of type RC30/RC35 an RC20 is emulated. For the BC400 the options are RC100, RC100H and RT800. For a Junkers/Bosch FW120 and similar an FB10 or FB100 are emulated. And for RC100/RC200/RC3x0 you can use choose to emulate a RC100, RC200 or a RC100H.

To activate the Remote Thermostat feature follow these steps:

- set `thermostat/hc<x>/control` (or Room Control in the WebUI) to the remote thermostat you want to control
- send `thermostat/hc<x>/remotetemp` with your desired temperature. Optionally for an RC100H send `thermostat/hc<x>/remotehum` with a value for the humidity

EMS-ESP will search for the master thermostat and create a new thermostat with entities for room temperature and optionally humidity. These values will automatically be updated and synchronized with the master thermostat.

To stop the function, follow these steps:

- send `thermostat/hc<x>/remotetemp` with a value of `-1`
- set `thermostat/hc<x>/control` back to the master thermostat model type

The remote thermostat will remain in the EMS-ESP device dashboard but will have no entities.

Note, if the control is set to `roomthermostat` and the first temperature value for `remotetemp` is not sent within a minute, the master thermostat will likely show an error message.

<!-- prettier-ignore -->
!!! warning "Disclaimer"
    With the remote setting of the humidity you are able to set a heat pump to start cooling even when it is below the actual dew point, which can cause condensation on pipes and the floor, and subsequently damage the system. Use at your own risk!

### Scheduling temperature settings

The EMS-ESP Scheduler can be used to permanently maintain the remote thermostat's values. The thermostat is recreated once the command is and has an initial value as shown below:

![EMS-SCHEDULE-EDIT](_media/screenshot/scheduler_a.jpg)

- `Timer` to `00:00` for triggering as soon as EMS-ESP powers on
- `Command` is `thermostat/hc1/remotetemp` for heating circuit 1 (or `thermostat/hc1/remotehum` for an RC100H)
- `Value` is the optimal room temperature for your home, or a command (see below)
- `Name` is optional. By giving it a name it can be set remotely as a command and the activation state is published in an MQTT topic.

If you have an external Dallas temperature sensor attached to the EMS-ESP you can set the `value` to this value by using `temperaturesensor/<dallas_id_or_name>` as the `value`.

With both a temperature and humidity value set, the emulated RC100H would look lie this:

![EMS-SCHEDULE-MAIN](_media/screenshot/scheduler_b.jpg)

## Using the Message API for advanced logic functions

You can use the system API endpoint `message` to text send a message to the log and MQTT, however the message can also contain complex logic similar to that seen in the Scheduler. For example sending

```sh
curl -X POST \
    -H "Authorization: Bearer ${emsesp_token}" \
    -H "Content-Type: application/json" \
    -d '{"value":"system/settings/locale"}' \
    ${emsesp_url}/api/system/message
```

And examples replacing the value with:

- `(custom/test_seltemp - boiler/flowtempoffset) * 2.8 + 5"`
- `"boiler/storagetemp2 == null ? 'no' : 'yes'"`
